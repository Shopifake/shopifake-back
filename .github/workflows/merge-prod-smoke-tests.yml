name: Production Smoke Tests

on:
  workflow_call:
    inputs:
      lock-path:
        description: 'Relative path of the lock file'
        required: true
        type: string

jobs:
  smoke-tests:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 5
    env:
      KUBECONFIG: /tmp/kubeconfig
      NAMESPACE: shopifake-prod

    steps:
      - name: Setup kubeconfig
        env:
          KUBECONFIG_BASE64: ${{ secrets.KUBECONFIG }}
        run: |
          echo "$KUBECONFIG_BASE64" | base64 -d > $KUBECONFIG
          chmod 600 $KUBECONFIG

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'

      - name: Verify all pods are running
        run: |
          echo "Checking pod status..."
          
          NOT_RUNNING=$(kubectl get pods -n $NAMESPACE --no-headers | grep -v "Running\|Completed" | wc -l)
          if [ "$NOT_RUNNING" -gt 0 ]; then
            echo "Some pods are not running:"
            kubectl get pods -n $NAMESPACE | grep -v "Running\|Completed"
            exit 1
          fi
          
          echo "All pods are running"
          kubectl get pods -n $NAMESPACE

      - name: Check public gateway health
        run: |
          echo "Testing public gateway health endpoint..."
          
          # Test public health endpoint
          MAX_ATTEMPTS=5
          ATTEMPT=0
          SUCCESS=false
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://shopifake.com/api/actuator/health/ 2>/dev/null || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ Public gateway health check passed (HTTP $HTTP_CODE)"
              SUCCESS=true
              break
            else
              echo "⚠️  Attempt $ATTEMPT failed (HTTP $HTTP_CODE)"
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                echo "Waiting 10 seconds before retry..."
                sleep 10
              fi
            fi
          done
          
          if [ "$SUCCESS" = "false" ]; then
            echo "❌ Public gateway health check failed after $MAX_ATTEMPTS attempts"
            echo "Getting gateway pod logs..."
            GATEWAY_POD=$(kubectl get pods -n $NAMESPACE -l app.kubernetes.io/name=shopifake-gateway -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
            if [ -n "$GATEWAY_POD" ]; then
              kubectl logs -n $NAMESPACE $GATEWAY_POD --tail=50
            fi
            exit 1
          fi

      - name: Check gateway health (internal)
        run: |
          echo "Testing internal gateway health endpoint..."
          
          # Check if gateway service exists
          if ! kubectl get svc shopifake-gateway -n $NAMESPACE &>/dev/null; then
            echo "Warning: Gateway service not found, skipping health check"
            exit 0
          fi
          
          # Setup port-forward in background
          echo "Setting up port-forward..."
          kubectl port-forward -n $NAMESPACE svc/shopifake-gateway 8080:8080 &
          PF_PID=$!
          
          # Ensure port-forward cleanup on exit
          trap "kill $PF_PID 2>/dev/null || true; wait $PF_PID 2>/dev/null || true" EXIT
          
          # Wait for port-forward to be ready
          sleep 5
          
          # Test health endpoint
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/actuator/health 2>/dev/null || echo "000")
          
          # Cleanup port-forward immediately
          kill $PF_PID 2>/dev/null || true
          wait $PF_PID 2>/dev/null || true
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Internal gateway health check passed (HTTP $HTTP_CODE)"
          else
            echo "❌ Internal gateway health check failed (HTTP $HTTP_CODE)"
            GATEWAY_POD=$(kubectl get pods -n $NAMESPACE -l app.kubernetes.io/name=shopifake-gateway -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
            if [ -n "$GATEWAY_POD" ]; then
              kubectl logs -n $NAMESPACE $GATEWAY_POD --tail=50
            fi
            exit 1
          fi

      - name: Check services health
        run: |
          echo "Checking service health endpoints..."
          
          SERVICES="shopifake-catalog shopifake-orders shopifake-inventory"
          FAILED=0
          
          for SERVICE in $SERVICES; do
            # Check if service exists
            if ! kubectl get svc $SERVICE -n $NAMESPACE &>/dev/null; then
              echo "Warning: $SERVICE service not found, skipping"
              continue
            fi
            
            # Use port-forward to test health
            kubectl port-forward -n $NAMESPACE svc/$SERVICE 8081:8080 &
            PF_PID=$!
            sleep 3
            
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8081/actuator/health 2>/dev/null || echo "000")
            
            # Cleanup port-forward
            kill $PF_PID 2>/dev/null || true
            wait $PF_PID 2>/dev/null || true
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "$SERVICE: OK (HTTP $HTTP_CODE)"
            else
              echo "$SERVICE: FAILED (HTTP $HTTP_CODE)"
              FAILED=$((FAILED + 1))
            fi
          done
          
          if [ "$FAILED" -gt 0 ]; then
            echo "$FAILED service(s) failed health check"
            exit 1
          fi
          
          echo "All service health checks passed"

      - name: Summary
        if: always()
        run: |
          echo "=== Deployment Summary ==="
          echo "Namespace: $NAMESPACE"
          echo ""
          echo "Pods:"
          kubectl get pods -n $NAMESPACE -o wide
          echo ""
          echo "Services:"
          kubectl get svc -n $NAMESPACE

