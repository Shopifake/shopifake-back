name: Production Cluster Healthcheck

on:
  workflow_call:
    secrets:
      KUBECONFIG:
        required: true
        description: The base64-encoded kubeconfig for the cluster

jobs:
  healthcheck:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 5
    env:
      KUBECONFIG: /tmp/kubeconfig
      NAMESPACE: shopifake-prod

    steps:
      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'

      - name: Setup kubeconfig
        env:
          KUBECONFIG_BASE64: ${{ secrets.KUBECONFIG }}
        run: |
          echo "$KUBECONFIG_BASE64" | base64 -d > $KUBECONFIG
          chmod 600 $KUBECONFIG
          if ! kubectl config view >/dev/null 2>&1; then
            echo "ERROR: Invalid kubeconfig"
            exit 1
          fi
          echo "Kubeconfig loaded successfully"

      - name: Check cluster connectivity
        run: |
          echo "Testing cluster connectivity..."
          if kubectl cluster-info >/dev/null 2>&1; then
            echo "Connected to cluster"
            kubectl cluster-info
          else
            echo "Cannot connect to cluster"
            exit 1
          fi

      - name: Verify namespace exists
        run: |
          echo "Checking if namespace '$NAMESPACE' exists..."
          if kubectl get namespace $NAMESPACE >/dev/null 2>&1; then
            echo "Namespace '$NAMESPACE' exists"
            kubectl get namespace $NAMESPACE
          else
            echo "ERROR: Namespace '$NAMESPACE' does not exist"
            echo "Available namespaces:"
            kubectl get namespaces
            exit 1
          fi

      - name: Check cluster nodes health
        run: |
          echo "Checking cluster nodes..."
          kubectl get nodes
          NOT_READY=$(kubectl get nodes --no-headers | grep -v " Ready" | wc -l)
          if [ "$NOT_READY" -gt 0 ]; then
            echo "WARNING: $NOT_READY node(s) are not ready"
          else
            echo "All nodes are ready"
          fi
