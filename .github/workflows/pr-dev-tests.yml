name: System Tests

on:
  workflow_call:
    inputs:
      compose-file:
        description: 'Optional docker-compose file to spin up the stack'
        required: false
        type: string
      lock-artifact-name:
        description: 'Name of the artifact containing the lock file'
        required: true
        type: string
      lock-filename:
        description: 'Filename of the lock within the artifact'
        required: true
        type: string
      system-command:
        description: 'Command to execute end-to-end/system tests'
        required: false
        type: string
        default: 'bash scripts/tests/run-system-tests.sh'

jobs:
  system-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github/images.json
            compose/
            scripts/tests/
            scripts/init-databases.sql

      - name: Download lock artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.lock-artifact-name }}
          path: locks

      - name: Extract images from lock
        id: images
        run: |
          set -euo pipefail
          LOCK_FILE="locks/${{ inputs.lock-filename }}"
          IMAGES_JSON=".github/images.json"
          
          # Extract image tags from lock, filtering only services defined in images.json
          # This automatically excludes monitoring/infra services without GHCR images
          # Format: SERVICE_NAME=ghcr.io/owner/image:tag
          IMAGE_MAP=$(jq -r --slurpfile registry "$IMAGES_JSON" '
            .services | to_entries[] | 
            select($registry[0][.key] != null) |
            "\(.key | ascii_upcase)=\(.value.image.repository):\(.value.image.tag)"
          ' "$LOCK_FILE")
          
          # Export as GitHub output (multi-line)
          echo "$IMAGE_MAP" | while IFS='=' read -r service image; do
            echo "${service}=${image}" >> "$GITHUB_OUTPUT"
          done
          
          # Also save to file for docker-compose substitution
          echo "$IMAGE_MAP" > /tmp/image-mapping.env
          cat /tmp/image-mapping.env

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull images from lock
        run: |
          set -euo pipefail
          MISSING_IMAGES=()
          
          while IFS='=' read -r service image; do
            echo "Pulling image for $service: $image"
            if docker pull "$image"; then
              echo "✓ Successfully pulled $image"
            else
              echo "✗ Failed to pull $image"
              MISSING_IMAGES+=("$image")
            fi
          done < /tmp/image-mapping.env
          
          if [ ${#MISSING_IMAGES[@]} -gt 0 ]; then
            echo "::error::The following images are missing from GHCR:"
            printf '  - %s\n' "${MISSING_IMAGES[@]}"
            exit 1
          fi

      - name: Generate docker-compose with lock images
        id: compose-gen
        run: |
          set -euo pipefail
          # Read lock and generate docker-compose override
          LOCK_FILE="locks/${{ inputs.lock-filename }}"
          IMAGES_JSON=".github/images.json"
          COMPOSE_OVERRIDE="/tmp/compose-override.yml"
          
          # Create override with image references from lock
          # Map lock service names (shopifake-*) to docker-compose service names (without prefix)
          cat > "$COMPOSE_OVERRIDE" <<EOF
          services:
          EOF
          
          # Extract images and map to docker-compose service names
          # Filter only services defined in images.json (same logic as pull step)
          jq -r --slurpfile registry "$IMAGES_JSON" '
            .services | to_entries[] | 
            select($registry[0][.key] != null) |
            "\(.key)\t\(.value.image.repository):\(.value.image.tag)"
          ' "$LOCK_FILE" | while IFS=$'\t' read -r service_name image_ref; do
              # Remove 'shopifake-' prefix for docker-compose service name
              compose_service="${service_name#shopifake-}"
              echo "  $compose_service:" >> "$COMPOSE_OVERRIDE"
              echo "    image: $image_ref" >> "$COMPOSE_OVERRIDE"
            done
          
          echo "compose-override=$COMPOSE_OVERRIDE" >> "$GITHUB_OUTPUT"
          echo "Generated compose override:"
          cat "$COMPOSE_OVERRIDE"

      - name: Verify init-databases.sql exists
        run: |
          set -euo pipefail
          if [ ! -f "scripts/init-databases.sql" ]; then
            echo "::error::init-databases.sql not found"
            exit 1
          fi
          echo "✓ init-databases.sql found"
          ls -la scripts/init-databases.sql

      - name: Start system stack
        id: start-stack
        run: |
          set -euo pipefail
          # Merge base compose with override from lock
          docker compose \
            -f "${{ inputs.compose-file }}" \
            -f "${{ steps.compose-gen.outputs.compose-override }}" \
            up -d --wait

      - name: Run system tests
        env:
          ENV: local
        run: |
          set -euo pipefail
          echo "Running system tests: ${{ inputs.system-command }}"
          ${{ inputs.system-command }}

      - name: Collect logs on failure
        if: failure()
        run: |
          docker compose \
            -f "${{ inputs.compose-file }}" \
            -f "${{ steps.compose-gen.outputs.compose-override }}" \
            logs || true

      - name: Tear down stack
        if: always()
        run: |
          docker compose \
            -f "${{ inputs.compose-file }}" \
            -f "${{ steps.compose-gen.outputs.compose-override }}" \
            down -v

