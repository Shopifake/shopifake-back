name: Staging Cluster Healthcheck

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment identifier'
        required: false
        type: string
        default: 'staging'
    secrets:
      KUBECONFIG:
        required: true
        description: The base64-encoded kubeconfig for the cluster, with default namespace "shopifake-sandbox" so that nobody messes up anything important namespaces by accident

jobs:
  healthcheck:
    runs-on: ubuntu-latest
    timeout-minutes: 1

    steps:
      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'

      - name: Setup kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_STAGING }}" | $HOME/.kube/config
          $HOME/.kube/config
          export KUBECONFIG=$HOME/.kube/config
          
          if ! kubectl config view >/dev/null 2>&1; then
            echo "âŒ ERROR: Invalid kubeconfig"
            exit 1
          fi
          echo "âœ… Kubeconfig loaded successfully"

      - name: Check cluster connectivity
        run: |
          echo "ğŸ” Testing cluster connectivity..."
          if kubectl cluster-info >/dev/null 2>&1; then
            echo "âœ… Connected to cluster"
            kubectl cluster-info
          else
            echo "âŒ Cannot connect to cluster"
            exit 1
          fi